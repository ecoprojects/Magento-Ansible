---
- name: Install apache2
  apt: pkg=apache2 state=installed

- name: Copy apache2 configuration for domain
  template: src=vhost_debian.conf dest=/etc/apache2/sites-enabled/{{ domain_name }}.conf

- name: restart apache2
  service: name=apache2 state=started enabled=yes

- name: start apache on reboot
  shell: sysv-rc-conf apache2 on

- name: Install php and deps 
  apt: pkg={{ item }} state=present
  with_items:
    - php5
    - php5-gd
    - php5-mysql
    - libapache2-mod-php5
    - php5-mcrypt
    - vim

- name: Install Varnish
  apt: pkg=varnish state=present
  
- name: Start varnish
  service: name=varnish state=started enabled=yes

- name: start varnish on reboot
  shell: sysv-rc-conf varnish on

- name: Install nfs-common
  apt: pkg=nfs-common state=installed

- name: Install nfs-kernel-server
  apt: pkg=nfs-kernel-server state=installed

- name: Start rpcbind and nfs
  service: name={{ item }} state=started enabled=yes
  with_items:
    - rpcbind
    - nfs-kernel-server

- name: NFS starts on reboot
  shell: sysv-rc-conf nfs-kernel-server on

- name: rpcbind starts on reboot
  shell: sysv-rc-conf rpcbind on

- name: Create domain directory and NFS directory
  shell: mkdir -p /var/www/vhosts/{{ domain_name }}/media
